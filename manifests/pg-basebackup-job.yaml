apiVersion: batch/v1
kind: Job
metadata:
  name: pg-basebackup
  namespace: postgresql
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 0
      containers:
        - name: pg-basebackup
          image: postgres:17
          command:
            - bash
            - -c
            - |
              set -e
              echo "Clearing data directory..."
              rm -rf /var/lib/postgresql/data/pgdata/*

              echo "Running pg_basebackup from $PRIMARY_HOST..."
              PGPASSWORD=test pg_basebackup \
                -h "$PRIMARY_HOST" \
                -p 30432 \
                -U replicator \
                -D /var/lib/postgresql/data/pgdata \
                -Fp -Xs -P -R \
                -S standby1_slot

              # Rewrite postgresql.auto.conf to only have correct settings
              # (pg_basebackup copies source's old config then appends new one)
              echo "Fixing postgresql.auto.conf..."
              echo "primary_conninfo = 'host=$PRIMARY_HOST port=30432 user=replicator password=test application_name=walreceiver'" > /var/lib/postgresql/data/pgdata/postgresql.auto.conf
              echo "primary_slot_name = 'standby1_slot'" >> /var/lib/postgresql/data/pgdata/postgresql.auto.conf

              echo "Setting permissions..."
              chown -R 999:999 /var/lib/postgresql/data/pgdata

              echo "Done. postgresql.auto.conf:"
              cat /var/lib/postgresql/data/pgdata/postgresql.auto.conf

              echo "standby.signal:"
              ls -la /var/lib/postgresql/data/pgdata/standby.signal
          env:
            - name: PRIMARY_HOST
              value: "PLACEHOLDER"
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: postgres-data-postgresql-0
