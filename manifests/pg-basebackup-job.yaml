apiVersion: batch/v1
kind: Job
metadata:
  name: pg-basebackup
  namespace: postgresql
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 0
      containers:
        - name: pg-basebackup
          image: bitnamilegacy/postgresql:17
          command:
            - bash
            - -c
            - |
              set -e
              echo "Clearing data directory..."
              rm -rf /bitnami/postgresql/data/*

              echo "Running pg_basebackup from $PRIMARY_HOST..."
              PGPASSWORD=test pg_basebackup \
                -h "$PRIMARY_HOST" \
                -p 30432 \
                -U replicator \
                -D /bitnami/postgresql/data \
                -Fp -Xs -P -R \
                -S standby1_slot

              echo "Setting permissions..."
              chown -R 1001:1001 /bitnami/postgresql/data

              echo "Done. postgresql.auto.conf:"
              cat /bitnami/postgresql/data/postgresql.auto.conf
          env:
            - name: PRIMARY_HOST
              value: "PLACEHOLDER"
          volumeMounts:
            - name: data
              mountPath: /bitnami/postgresql
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: postgres-data-postgresql-0
